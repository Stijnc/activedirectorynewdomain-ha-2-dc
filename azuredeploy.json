{
	"$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"newStorageAccountName": {
			"type": "string",
			 "metadata": {
				"Description": "The name of the new storage account created to store the VMs disks"
			},
			"defaultValue":"New Storage Account Name"
		},
		"storageAccountType": {
			"type": "string",
			"allowedValues": [
				"Standard_LRS",
				"Standard_GRS",
				"Standard_ZRS"
			],
			"metadata": {
				"Description": "The type of the Storage Account created"
			},
			"defaultValue":"Standard_LRS"
		},
		"deploymentLocation": {
			"type": "string",
			"allowedValues": [
				"West US",
				"East US",
				"West Europe",
				"East Asia",
				"Southeast Asia"
			],
			"metadata": {
				"Description": "The region to deploy the resources into"
			},
			"defaultValue":"West Europe"
		},
		"virtualNetworkName": {
			"type": "string",
			"metadata": {
				"Description": "The name of the Virtual Network to Create"
			},
			"defaultValue":"adVNET"
		},
		"virtualNetworkAddressRange": {
			"type": "string",
			"metadata": {
				"Description": "The address range of the new VNET in CIDR format"
			},
			"defaultValue":"10.0.0.0/16"
		},
		"adSubnetName": {
			"type": "string",
			"metadata": {
				"Description": "The name of the subnet created in the new VNET"
			},
			"defaultValue":"adSubnet"
		},
		"adSubnet": {
			"type": "string",
			"metadata": {
				"Description": "The address range of the subnet created in the new VNET"
			},
			"defaultValue":"10.0.0.0/24"
		},
		"adPDCNicName": {
			"type": "string",
			"metadata": {
				"Description": "The name of the NIC attached to the new PDC"
			},
			"defaultValue":"adPDCNic"
		},
		"adPDCNicIPAddress": {
			"type": "string",
			"metadata": {
				"Description": "The IP address of the new AD PDC"
			},
			"defaultValue":"10.0.0.4"
		},
		"adBDCNicName": {
			"type": "string",
			"metadata": {
				"Description": "The name of the NIC attached to the new BDC"
			},
			"defaultValue":"adBDCNic"
		},
		"adBDCNicIPAddress": {
			"type": "string",
			"metadata": {
				"Description": "The IP address of the new AD BDC"
			},
			"defaultValue":"10.0.0.5"
		},
		"publicIPAddressName": {
			"type": "string",
			"metadata": {
				"Description": "The name of the public IP address used by the Load Balancer"
			},
			"defaultValue":"adpublicIP"
		},
		"publicIPAddressType": {
			"type": "string",
			"allowedValues": [
				"Dynamic",
				"Static"
			],
			"metadata": {
				"Description": "The type of the public IP address used by the Load Balancer"
			},
			"defaultValue":"Dynamic"
		},
		"adPDCVMName": {
			"type": "string",
			"metadata": {
				"Description": "The computer name of the PDC"
			},
			"defaultValue":"adarmtestPDC"
		},
		"adBDCVMName": {
			"type": "string",
			"metadata": {
				"Description": "The computer name of the BDC"
			},
			"defaultValue":"adarmtestBDC"
		},
		"adminUsername": {
			"type": "string",
			"metadata": {
				"Description": "The name of the Administrator of the new VM and Domain"
			},
			"defaultValue":"adAdministrator"
		},
		"adminPassword": {
			"type": "securestring",
			"metadata": {
				"Description": "The password forthe Administrator account of the new VM and Domain"
			}
		},
		"adVMSize": {
			"type": "string",
			"allowedValues": [
				"Standard_A0",
				"Standard_A1",
				"Standard_A2",
				"Standard_A3",
				"Standard_A4"
			],
			"metadata": {
				"Description": "The size of the VM Created"
			},
			"defaultValue": "Standard_A1"
		},
		"adImageName": {
			"type": "string",
			"metadata": {
				"Description": "The name of the VM Image to create the AD VM from"
			},
			"defaultValue": "a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201502.01-en.us-127GB.vhd"
		},
		"vmContainerName": {
			"type":"string",
			"metadata": {
				"Description": "The container name in the storage account where VM disks are stored"
			},
			"defaultValue": "vhds"
		},
		"adAvailabilitySetName": {
			"type":"string",
			"metadata": {
				"Description": "The name of the availability set that the AD VM is created in"
			},
			"defaultValue":"adAvailabiltySet"
		},
		"domainName":{
			"type":"string",
			"metadata": {
				"Description": "The FQDN of the AD Domain created "
			},
			"defaultValue":"adarmtest.com"
		},
		"domainNetbiosName":{
			"type":"string",
			"metadata": {
				"Description": "The NetBIOS name of the AD Domain created "
			},
			"defaultValue":"adarmtest"
		},
		"adPDCModulesURL":{
			"type":"string",
			"metadata": {
				"Description": "The URL to the zip containing the DSC package that creates and installs AD"
			},
			"defaultValue":"https://raw.githubusercontent.com/simongdavies/activedirectorynewdomain-ha-2-dc/master/CreateADPDC.ps1.zip"
		},
		"adPDCConfigurationFunction":{
			"type":"string",
			"metadata": {
				"Description": "The name of the DSC Configuration Function that configures the VM , creates the AD Domain etc."
			},
			"defaultValue":"CreateADPDC.ps1\\CreateADPDC"
		},
		"adBDCModulesURL":{
			"type":"string",
			"metadata": {
				"Description": "The URL to the zip containing the DSC package that creates and installs the BDC"
			},
			"defaultValue":"https://raw.githubusercontent.com/simongdavies/activedirectorynewdomain-ha-2-dc/master/CreateADBDC.ps1.zip"
		},
		"adBDCConfigurationFunction":{
			"type":"string",
			"metadata": {
				"Description": "The name of the DSC Configuration Function that configures the VM , creates the BDC etc."
			},
			"defaultValue":"CreateADBDC.ps1\\CreateADBDC"
		},
		"addnsName":{
			"type":"string",
			"metadata": {
				"Description": "The DNS prefix for the public IP address used by the Load Balancer"
			},
			"defaultValue":"New DNS Prefix"
		},
		"PDCRDPPort":{
			"type":"int",
			"metadata": {
				"Description": "The public RDP port for the PDC VM"
			},
			"defaultValue":3389
		},
		"BDCRDPPort":{
			"type":"int",
			"metadata": {
				"Description": "The public RDP port for the BDC VM"
			},
			"defaultValue":13389
		}
	},
	"variables": {
		"VnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
		"adSubnetRef": "[concat(variables('VnetID'),'/subnets/',parameters('adSubnetName'))]",
		"adSourceImageName": "[concat('/',subscription().subscriptionId,'/services/images/',parameters('adImageName'))]",
		"adPDCNicId" : "[resourceId('Microsoft.Network/networkInterfaces',parameters('adPDCNicName'))]",
		"adPDCIPConfigID": "[concat(variables('adPDCNicId'),'/ipConfigurations/ipconfig1')]",
		"adBDCNicId" : "[resourceId('Microsoft.Network/networkInterfaces',parameters('adBDCNicName'))]",
		"adBDCIPConfigID": "[concat(variables('adBDCNicId'),'/ipConfigurations/ipconfig1')]",
		"adLBName" : "adLoadBalancer",
		"adlbID":"[resourceId('Microsoft.Network/loadBalancers',variables('adLBName'))]",
		"adlbFEConfigID":"[concat(variables('adlbID'),'/frontendIPConfigurations/LBFE')]",
		"adPDCDataDisk":"ADPDCDataDisk",
		"adBDCDataDisk":"ADBDCDataDisk",
		"adDataDiskSize":1000,
		"lbTemplateUri":"https://raw.githubusercontent.com/simongdavies/activedirectorynewdomain-ha-2-dc/VNetLink/ad-ha-loadbalancer.json",
		"adTemplateUri":"https://raw.githubusercontent.com/simongdavies/AzureRMActiveDirectory/VNetLink/azuredeploy.json",
		"vnetwithDNSTemplateUri":"https://raw.githubusercontent.com/simongdavies/AzureRMActiveDirectory/VNetLink/vnet-with-dns-server.json"
	},
	"resources": [
		{
			"name": "DeployAD",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2015-01-01",
			"properties": {
				"mode": "Incremental",
				"templateLink": {
				  "uri": "[variables('adTemplateUri')]",
				  "contentVersion": "1.0.0.0"
				},
				"parameters": {
					"newStorageAccountName": {"value":"[parameters('newStorageAccountName')]"},
					"storageAccountType": {"value":"[parameters('storageAccountType')]"},
					"deploymentLocation":  {"value":"[parameters('deploymentLocation')]"},
					"virtualNetworkName": {"value":"[parameters('virtualNetworkName')]"},
					"virtualNetworkAddressRange": {"value":"[parameters('virtualNetworkAddressRange')]"},
					"adSubnetName": {"value":"[parameters('adSubnetName')]"},
					"adSubnet": {"value":"[parameters('adSubnet')]"},
					"adNicName":{"value":"[parameters('adPDCNicName')]"},
					"adNicIPAddress": {"value":"[parameters('adPDCNicIPAddress')]"},
					"publicIPAddressName": {"value":"[parameters('publicIPAddressName')]"},
					"publicIPAddressType": {"value":"[parameters('publicIPAddressType')]"},
					"adVMName": {"value":"[parameters('adPDCVMName')]"},
					"adminUsername": {"value":"[parameters('adminUsername')]"},
					"adminPassword": {"value":"[parameters('adminPassword')]"},
					"adVMSize": {"value":"[parameters('adVMSize')]"},
					"adImageName": {"value":"[parameters('adImageName')]"},
					"vmContainerName": {"value":"[parameters('vmContainerName')]"},
					"adAvailabilitySetName":{"value":"[parameters('adAvailabilitySetName')]"},
					"domainName":{"value":"[parameters('domainName')]"},
					"domainNetbiosName":{"value":"[parameters('domainNetbiosName')]"},
					"adModulesURL":{"value":"[parameters('adPDCModulesURL')]"},
					"adConfigurationFunction":{"value":"[parameters('adPDCConfigurationFunction')]"},
					"addnsName":{"value":"[parameters('addnsName')]"},
					"RDPPort":{"value":"[parameters('PDCRDPPort')]"}
				},
			},
		},
		{
		 "name": "[parameters('adBDCNicName')]",
		 "type": "Microsoft.Network/networkInterfaces",
		 "location": "[parameters('deploymentLocation')]",
		 "dependsOn": ["Microsoft.Resources/deployments/DeployAD"],
		 "apiVersion": "2014-12-01-preview",
		 "properties": {
			 "ipConfigurations": [
				 {
					 "name": "ipconfig1",
					 "properties": {
						"privateIPAllocationMethod": "Static",
						"privateIPAddress" :"[parameters('adBDCNicIPAddress')]",
						"subnet": {
							"id": "[variables('adSubnetRef')]"
						 }
					 }
				 }
			 ]
		 }
		},
		{
			"name": "UpdateLoadBalancer",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2015-01-01",
			"dependsOn": [
				  "[concat('Microsoft.Network/networkInterfaces/', parameters('adBDCNicName'))]"
			],
			"properties": {
				"mode": "Incremental",
				"templateLink": {
				  "uri": "[variables('lbTemplateUri')]",
				  "contentVersion": "1.0.0.0"
				},
				"parameters": {
					"deploymentLocation": {"value":"[parameters('deploymentLocation')]"},
					"publicIPAddressName": {"value":"[parameters('publicIPAddressName')]"},
					"lbName": {"value":"[variables('adLBName')]"},
					"adPDCNicName": {"value":"[parameters('adPDCNicName')]"},
					"adBDCNicName": {"value":"[parameters('adBDCNicName')]"},
					"PDCRDPPort": {"value":"[parameters('PDCRDPPort')]"},
					"BDCRDPPort": {"value":"[parameters('BDCRDPPort')]"}
				}
			}
		},
		{
			"apiVersion": "2014-12-01-preview",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[parameters('adBDCVMName')]",
			"location": "[parameters('deploymentLocation')]",
			"dependsOn": [
				"[resourceId('Microsoft.Network/networkInterfaces',parameters('adBDCNicName'))]"
			],
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('adVMSize')]"
				},
				"availabilitySet": {
					"id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('adAvailabilitySetName'))]"
				},
				"osProfile": {
					"computername": "[parameters('adBDCVMName')]",
					"adminUsername": "[parameters('adminUsername')]",
					"adminPassword": "[parameters('adminPassword')]",
					"windowsProfile": {
						"provisionVMAgent": "true"
					}
				},
				"storageProfile": {
					"sourceImage": {
						"id": "[variables('adSourceImageName')]"
					},
					"destinationVhdsContainer": "[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/',parameters('vmContainerName'),'/')]",
					"dataDisks": [
						{
							"vhd": {
								"uri":"[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/',parameters('vmContainerName'),'/', variables('adBDCDataDisk'),'-1.vhd')]"
								},
							"name":"[concat(parameters('adBDCVMName'),'-data-disk1')]",
							"caching" : "None",
							"diskSizeGB": "[variables('adDataDiskSize')]",
							"lun": 0
						}
					]
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces',parameters('adBDCNicName'))]"
						}
					]
				}
			},
			"resources" :[
				{
					"type": "Microsoft.Compute/virtualMachines/extensions",
					"name": "[concat(parameters('adBDCVMName'),'/CreateBDC')]",
					"apiVersion": "2014-12-01-preview",
					"location": "[parameters('deploymentLocation')]",
					"dependsOn":[
							"[concat('Microsoft.Compute/virtualMachines/', parameters('adBDCVMName'))]"
					],
					"properties": {
						"publisher": "Microsoft.Powershell",
						"type": "DSC",
						"typeHandlerVersion": "1.7",
						"settings": {
							"ModulesUrl": "[parameters('adBDCModulesURL')]",
							"ConfigurationFunction": "[parameters('adBDCConfigurationFunction')]",
							"Properties": {
								"DomainName": "[parameters('domainName')]",
								"DomainNetBiosName":"[parameters('domainNetbiosName')]",
								"AdminCreds":{
									"UserName": "[parameters('adminUserName')]",
									"Password": "PrivateSettingsRef:AdminPassword"
								}
							}
						},
						"protectedSettings": {
							"Items": {
								"AdminPassword": "[parameters('adminPassword')]"
							}
						}
					}
				}
			]
		},
		{
			"name": "UpdateVNetDNS",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2015-01-01",
			"dependsOn": [
				"[concat('Microsoft.Compute/virtualMachines/',parameters('adBDCVMName'),'/extensions/CreateBDC')]"
			],
			"properties": {
				"mode": "Incremental",
				"templateLink": {
				  "uri": "[variables('vnetwithDNSTemplateUri')]",
				  "contentVersion": "1.0.0.0"
				},
				"parameters": {
					"deploymentLocation": {"value":"[parameters('deploymentLocation')]"},
					"virtualNetworkName": {"value":"[parameters('virtualNetworkName')]"},
					"virtualNetworkAddressRange": {"value":"[parameters('virtualNetworkAddressRange')]"},
					"subnetName": {"value":"[parameters('adSubnetName')]"},
					"subnetRange": {"value":"[parameters('adSubnet')]"},
					"DNSServerAddress": {"value":"[concat(parameters('adPDCNicIPAddress'),',',parameters('adBDCNicIPAddress'))]"}
				}
			}
		}
	]
}